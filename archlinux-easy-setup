#!/usr/bin/env bash
# =====================================================
# Arch Linux Easy Setup Script
# Version: 2.0.0
# Author: Your Name
# Repository: https://github.com/yourusername/archlinux-easy-setup
# =====================================================
# Description:
# One-click setup script for Arch Linux that installs essential
# packages and configures the system for daily use.
# Combines the ease of Debian with the freshness of Arch.
# =====================================================

set -euo pipefail  # Exit on error, unset variables, and pipe failures

# Color codes for output
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
NC='\033[0m' # No Color

# Helper functions
print_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" >&2
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Function to check for script updates
check_for_updates() {
    print_info "Checking for script updates..."
    if command -v curl &> /dev/null; then
        LATEST_VERSION=$(curl -s https://api.github.com/repos/yourusername/archlinux-easy-setup/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' 2>/dev/null || echo "")
        if [[ -n "$LATEST_VERSION" && "$LATEST_VERSION" != "2.0.0" ]]; then
            print_warning "A newer version ($LATEST_VERSION) is available!"
            print_info "Download from: https://github.com/yourusername/archlinux-easy-setup"
            read -rp "Continue with current version? [y/N] " update_response
            if [[ ! "$update_response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
                print_info "Update the script with:"
                echo "curl -L https://raw.githubusercontent.com/yourusername/archlinux-easy-setup/main/setup.sh -o setup.sh"
                exit 0
            fi
        fi
    fi
}

check_for_updates

# Check if running as root
if [[ $EUID -eq 0 ]]; then
    print_error "Do not run this script as root. Run as a regular user."
    exit 1
fi

# Check sudo permissions
if ! sudo -v; then
    print_error "No sudo permissions. Add user to wheel group first."
    exit 1
fi

print_info "Checking internet connection..."
if ! curl -s --connect-timeout 10 https://archlinux.org > /dev/null; then
    print_error "No internet connection. Please check your connection."
    exit 1
fi

print_info "Updating system..."
print_warning "This will update all system packages and may take some time."
read -rp "Continue? [y/N] " response
if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
    sudo pacman -Syu --noconfirm
else
    print_info "Skipping system update."
fi

# Optional Chaotic-AUR repository
print_warning "Chaotic-AUR repository may contain potential security risks."
print_warning "In 2025, malicious packages with RATs were found in AUR."
read -rp "Add Chaotic-AUR repository? [y/N] " chaotic_response

if [[ "$chaotic_response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
    print_info "Adding Chaotic-AUR repository..."

    if ! grep -q "chaotic-aur" /etc/pacman.conf; then
        sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com || \
        sudo pacman-key --recv-key 3056513887B78AEB --keyserver hkps://keyserver.ubuntu.com

        sudo pacman-key --lsign-key 3056513887B78AEB

        sudo pacman -U --noconfirm \
            'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst' \
            'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'

        echo '[chaotic-aur]' | sudo tee -a /etc/pacman.conf
        echo 'Include = /etc/pacman.d/chaotic-mirrorlist' | sudo tee -a /etc/pacman.conf

        print_info "Updating package lists..."
        sudo pacman -Sy
    else
        print_info "Chaotic-AUR repository already exists."
    fi
else
    print_info "Skipping Chaotic-AUR repository."
fi

print_info "Installing core packages..."

# Core packages list
core_packages=(
    # Media
    mpv vlc vlc-plugins-all obs-studio

    # Internet & Browsers
    firefox firefox-i18n-ar torbrowser-launcher

    # System & Monitoring
    networkmanager flatpak pavucontrol fastfetch gparted
    gamemode btop unzip p7zip filelight xdotool
    scrcpy kamoso torsocks sshfs

    # Fonts
    noto-fonts noto-fonts-arabic noto-fonts-emoji
    ttf-dejavu ttf-liberation cantarell-fonts
    ttf-amiri ttf-scheherazade-new

    # Interface & Customization
    qt5ct kvantum gwenview

    # Development tools
    base-devel git

    # Shell
    fish

    # Windows compatibility
    wine
)

# Install NetworkManager first
if ! pacman -Qi networkmanager &> /dev/null; then
    print_info "Installing NetworkManager..."
    sudo pacman -S --noconfirm networkmanager
fi

print_info "Enabling NetworkManager..."
if ! systemctl is-enabled NetworkManager &> /dev/null; then
    sudo systemctl enable --now NetworkManager
else
    print_info "NetworkManager already enabled."
fi

# Install core packages
failed_packages=()
for pkg in "${core_packages[@]}"; do
    if ! pacman -Qi "$pkg" &> /dev/null 2>&1; then
        print_info "Installing $pkg..."
        if sudo pacman -S --needed --noconfirm "$pkg"; then
            print_success "Installed $pkg"
        else
            print_warning "Failed to install $pkg"
            failed_packages+=("$pkg")
        fi
    else
        print_info "$pkg already installed."
    fi
done

# Report failed packages
if [ ${#failed_packages[@]} -gt 0 ]; then
    print_warning "Failed to install the following packages:"
    for failed in "${failed_packages[@]}"; do
        echo "  - $failed"
    done
fi

# Laptop packages (optional)
print_info "Checking device type..."
read -rp "Are you using a laptop? [y/N] " laptop_response

if [[ "$laptop_response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
    print_info "Installing laptop packages..."

    laptop_packages=(
        tlp         # Power management
        acpi        # Battery information
        lm_sensors  # Temperature monitoring
    )

    for pkg in "${laptop_packages[@]}"; do
        if ! pacman -Qi "$pkg" &> /dev/null; then
            print_info "Installing $pkg..."
            sudo pacman -S --needed --noconfirm "$pkg" || print_warning "Failed to install $pkg"
        else
            print_info "$pkg already installed."
        fi
    done

    # Enable TLP
    print_info "Enabling TLP service..."
    if ! systemctl is-enabled tlp &> /dev/null; then
        sudo systemctl enable --now tlp
        print_success "TLP enabled for better power management."
    else
        print_info "TLP already enabled."
    fi

    # Setup lm_sensors
    print_info "Setting up temperature sensors..."
    if command -v sensors-detect &> /dev/null; then
        print_warning "Running sensors-detect. Press ENTER to continue at each prompt unless you're sure."
        sudo sensors-detect --auto
    fi
else
    print_info "Skipping laptop packages."
fi

# Install yay (AUR helper)
print_info "Installing yay (AUR helper)..."
if ! command -v yay &> /dev/null; then
    build_dir="$HOME/.cache/yay-build"
    rm -rf "$build_dir" 2>/dev/null || true
    git clone https://aur.archlinux.org/yay.git "$build_dir"
    cd "$build_dir"
    makepkg -si --noconfirm
    cd
    rm -rf "$build_dir"
else
    print_info "yay already installed."
fi

# AUR packages (optional)
aur_packages=(
    # Tools
    xclicker auto-cpufreq

    # Media
    ani-cli-arabic spotube

    # System
    stacer visual-studio-code-bin

    # Input
    input-remapper-git
)

print_info "Installing AUR packages..."
read -rp "Install AUR packages? [y/N] " aur_response
if [[ "$aur_response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
    for aur_pkg in "${aur_packages[@]}"; do
        if ! yay -Qi "$aur_pkg" &> /dev/null 2>&1; then
            print_info "Installing $aur_pkg from AUR..."
            if yay -S --needed --noconfirm "$aur_pkg"; then
                print_success "Installed $aur_pkg"
            else
                print_warning "Failed to install $aur_pkg"
            fi
        else
            print_info "$aur_pkg already installed from AUR."
        fi
    done
fi

# Enable input-remapper if installed
print_info "Checking for input-remapper..."
if pacman -Qi input-remapper &> /dev/null || yay -Qi input-remapper-git &> /dev/null; then
    print_info "Enabling input-remapper service..."
    if ! systemctl is-enabled input-remapper &> /dev/null; then
        sudo systemctl enable --now input-remapper
        print_success "input-remapper service enabled."
    else
        print_info "input-remapper service already enabled."
    fi
fi

# Font configuration
print_info "Setting up font configuration..."
font_config_dir="$HOME/.config/fontconfig"
font_config_file="$font_config_dir/fonts.conf"

mkdir -p "$font_config_dir"

cat > "$font_config_file" <<'EOF'
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
  <alias>
    <family>sans-serif</family>
    <prefer>
      <family>Cantarell</family>
      <family>Noto Sans</family>
    </prefer>
  </alias>

  <alias>
    <family>serif</family>
    <prefer>
      <family>DejaVu Serif</family>
      <family>Noto Serif</family>
    </prefer>
  </alias>

  <alias>
    <family>monospace</family>
    <prefer>
      <family>DejaVu Sans Mono</family>
      <family>Noto Mono</family>
    </prefer>
  </alias>

  <match target="pattern">
    <test name="lang" compare="contains">
      <string>ar</string>
    </test>
    <edit name="family" mode="prepend" binding="strong">
      <string>Noto Naskh Arabic</string>
    </edit>
  </match>
</fontconfig>
EOF

print_info "Rebuilding font cache..."
fc-cache -f -v

# Flatpak setup
print_info "Setting up Flatpak..."
if ! flatpak remotes | grep -q "flathub"; then
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
else
    print_info "Flathub repository already exists."
fi

print_info "Installing Flatseal (optional)..."
read -rp "Install Flatseal? [y/N] " flatseal_response
if [[ "$flatseal_response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
    if ! flatpak list | grep -q "Flatseal"; then
        flatpak install -y flathub com.github.tchx84.Flatseal
    else
        print_info "Flatseal already installed."
    fi
fi

# Cleanup
print_info "Cleaning up package cache..."
sudo pacman -Sc --noconfirm 2>/dev/null || true
if command -v yay &> /dev/null; then
    yay -Sc --noconfirm 2>/dev/null || true
fi

# Set fish as default shell (optional)
print_info "Setting fish as default shell (optional)..."
read -rp "Set fish as default shell? [y/N] " fish_response
if [[ "$fish_response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
    if ! grep -q "/usr/bin/fish" /etc/shells; then
        echo "/usr/bin/fish" | sudo tee -a /etc/shells
    fi

    if [[ "$SHELL" != "/usr/bin/fish" ]]; then
        chsh -s /usr/bin/fish
        print_success "Fish set as default shell. Changes apply after re-login."
    else
        print_info "Fish is already the default shell."
    fi
else
    print_info "Skipping fish shell setup."
fi

# Completion message
print_success "Setup completed successfully!"
echo ""
echo "================================================================"
echo "                    Setup Summary                               "
echo "================================================================"
echo ""
if [[ "$laptop_response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
    echo "âœ“ Laptop packages installed (TLP, lm_sensors, acpi)"
    echo "  - Use 'sudo tlp-stat' to check TLP status"
    echo "  - Use 'sensors' to monitor temperature"
fi

if pacman -Qi input-remapper &> /dev/null || yay -Qi input-remapper-git &> /dev/null; then
    echo "âœ“ input-remapper service enabled"
    echo "  - Use 'input-remapper-gtk' to configure input buttons"
fi

echo ""
echo "ðŸ”§ Additional Tips:"
echo "1. Restart your system to apply all changes"
echo "2. For OBS Studio: Open 'obs' from the menu"
echo "3. For power management on laptops: 'sudo systemctl start tlp'"
echo "4. To monitor system: Use 'btop' or 'stacer'"
echo "5. For Flatpak permission control: Use Flatseal"
echo ""
echo "ðŸ“š Useful Commands:"
echo "  - System updates: sudo pacman -Syu"
echo "  - AUR updates: yay -Syu"
echo "  - Clean package cache: yay -Sc"
echo "  - Remove orphans: sudo pacman -Rns \$(pacman -Qtdq)"
echo ""
echo "================================================================"

# Save setup log
log_file="$HOME/arch-setup-$(date +%Y%m%d-%H%M%S).log"
{
    echo "Arch Linux Setup Log - $(date)"
    echo "================================================================"
    echo "Installed core packages:"
    printf '%s\n' "${core_packages[@]}"

    if [[ "$laptop_response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
        echo ""
        echo "Installed laptop packages:"
        printf '%s\n' "${laptop_packages[@]}"
    fi

    echo ""
    echo "Installed AUR packages: ${aur_packages[*]}"
    echo ""
    echo "================================================================"
    echo "Chaotic-AUR added: $chaotic_response"
    echo "Device type: $( [[ "$laptop_response" =~ ^([yY][eE][sS]|[yY])$ ]] && echo "Laptop" || echo "Desktop" )"
    echo "Fish set as default shell: $fish_response"
    echo "input-remapper enabled: $(pacman -Qi input-remapper &> /dev/null || yay -Qi input-remapper-git &> /dev/null && echo "Yes" || echo "No")"
} > "$log_file"

print_info "Setup log saved to: $log_file"

